# Flash messages with Hotwire

​	本章节，我们将学习如何添加 flash messages 通过Turbo，并且如何通过Stimulus做出好看的动画效果。

## Adding flash messages to our CRUD controller

现在我们`Quote`模型的增删改查已经正常运转了，现在我们想添加`flash message`去提高系统的可用性。

在使用Turbo增加flash message之前，我们需要先来用不使用Turbo的版本，也就是Rails7之前的方式，而为了做到这一点，我们需要禁用Turbo在整个项目中。

```js
// app/javascript/application.js

import "./controllers"

// The two following lines disable Turbo on the whole application
import { Turbo } from "@hotwired/turbo-rails"
Turbo.session.drive = false
```

这样我们就禁用了Turbo，你可以在浏览器中测试一下，看一下这次是不是就变成跳转页面了。

其实我们在第一章时就使用了flash messages当`#create #update #destory`成功时，通过`notice`选项

```ruby
class QuotesController < ApplicationController
  # All the previous code

  def create
    @quote = current_company.quotes.build(quote_params)

    if @quote.save
      respond_to do |format|
        format.html { redirect_to quotes_path, notice: "Quote was successfully created." }
        format.turbo_stream
      end
    else
      render :new, status: :unprocessable_entity
    end
  end

  # All the previous code

  def update
    if @quote.update(quote_params)
      redirect_to quotes_path, notice: "Quote was successfully updated."
    else
      render :edit, status: :unprocessable_entity
    end
  end

  # All the previous code

  def destroy
    @quote.destroy

    respond_to do |format|
      format.html { redirect_to quotes_path, notice: "Quote was successfully destroyed." }
      format.turbo_stream
    end
  end
end
```

---

**注意**：如果你不熟悉`notice`标记去使用flash messages，那么下面两行语法是一致的

```ruby
# Syntax 1
redirect_to quotes_path, notice: "Quote was successfully created."

# Syntax 2
flash[:notice] = "Quote was successfully created."
redirect_to quotes_path
```

---

我们会先展示不使用Turbo的flash messages，并抽离出一个局部页面partial

```ruby
<%# app/views/layouts/_flash.html.erb %>

<% flash.each do |flash_type, message| %>
  <div class="flash__message">
    <%= message %>
  </div>
<% end %>
```

我们将在每个页面中都渲染这个包含flash message的局部页面。

```ruby
<!DOCTYPE html>
<html>
  <head>
    <!-- All the head code -->
  </head>

  <body>
    <%= render "layouts/navbar" %>

    <div class="flash">
      <%= render "layouts/flash" %>
    </div>

    <%= yield %>
  </body>
</html>
```

现在我们可以在浏览器中试试效果，增，删，改 都可以正常显示，我们再加一点儿css让它看起来更好看

```css
// app/assets/stylesheets/components/_flash.scss

.flash {
  position:fixed;
  top: 5rem;
  left: 50%;
  transform: translateX(-50%);

  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-s);

  max-width: 100%;
  width: max-content;
  padding: 0 var(--space-m);

  &__message {
    font-size: var(--font-size-s);
    color: var(--color-white);
    padding: var(--space-xs) var(--space-m);
    background-color: var(--color-dark);
    animation: appear-then-fade 4s both;
    border-radius: 999px;
  }
}
```

这里的`.flash CSS class`是我们flash messages的容器，它在屏幕上是固定位置，每个独立的flash message都被`.flash_message CSS class`装饰，我们将使用`apper-then-fade`,一个自定义动画来展示flash messages。

```css
// app/assets/stylesheets/config/_animations.scss

@keyframes appear-then-fade {
  0%, 100% {
    opacity:0
  }
  5%, 60% {
    opacity:1
  }
}
```

这两个文件添加后，我们把它们加入到样式清单中。

```css
// app/assets/stylesheets/application.sass.scss

@import "components/flash";
@import "config/animations";
```

我们在浏览器中看看效果吧，在登陆和注册时都会弹出对应的flash信息

---

这里我在测试增删改时，发现并没有弹出flash message信息，看一下下面有没有解决方案

---

当前系统有个小问题，当将鼠标移动到flash message区域，我们的鼠标样式即使在flash message消失时，也还是没有变，这是因为虽然我们的flash message可见度为9，但它依然存在于DOM上，并在页面数据上面，为了解决这个问题，我们需要从DOM中删除flash messages当消失时。

